#!/usr/bin/env python3
# coding=utf-8
#
# Import exploit database into cve-search
#
# Origin: https://github.com/offensive-security/exploit-database
#
# Software is free software released under the "Modified BSD license"
#
# Copyright (c) 2015    Alexandre Dulaunoy - a@foo.be

import os
import sys
import shutil
runPath = os.path.dirname(os.path.realpath(__file__))
sys.path.append(os.path.join(runPath, ".."))

from lib.Config import Configuration

import csv

# dictionary
exploitdburl = Configuration.getexploitdbDict()
tmppath = Configuration.getTmpdir()

# connect to db
db = Configuration.getMongoConnection()
exploitdb = db.exploitdb
info = db.info

try:
    f = Configuration.getFile(exploitdburl)
except:
    sys.exit("Cannot open url %s. Bad URL or not connected to the internet?"%(exploitdburl))

i = info.find_one({'db': 'exploitdb'})
if i is not None:
    if f.headers['last-modified'] == i['last-modified']:
        print("Not modified")
        sys.exit(0)

if not os.path.exists(tmppath):
    os.mkdir(tmppath)

csvfile = tmppath+'/exploitdb.csv'
with open(csvfile, 'wb') as fp:
    shutil.copyfileobj(f, fp)
fp.close()

bulk = exploitdb.initialize_ordered_bulk_op()

with open(csvfile, newline='') as csvtoparse:
    exploitcsv = csv.DictReader(csvtoparse, delimiter=',')
    for row in exploitcsv:
        bulk.find({'id': row['id']}).upsert().update({"$set": {'description': row['description'], 'type': row['type'], 'date': row['date'], 'port': row['port'], 'author': row['author'], 'file': row['file'], 'platform': row['platform'], 'id': row['id']}})

bulk.execute()

# Update last-modified
info.update({'db': 'exploitdb'}, {"$set": {'last-modified': f.headers['last-modified']}}, upsert=True)
